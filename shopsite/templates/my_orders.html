<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Orders - Handmade Store</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #fbf6f0; font-family: 'Segoe UI', Arial, sans-serif; }
    .container { max-width: 800px; margin: auto; padding: 20px; }
    h2 { color: #a3663a; }

    .accordion-item { background: #fff8f2; border-radius: 15px; }
    .accordion-button { background: #fff8f2; color: #a3663a; }
    .accordion-button:not(.collapsed) { background: #a3663a; color: white; }

    .order-tracker {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 20px 0;
      position: relative;
    }
    .order-tracker::before {
      content: "";
      position: absolute;
      top: 20px;
      left: 12%;
      right: 12%;
      height: 4px;
      background: #ddd;
      z-index: 0;
    }
    .step {
      text-align: center;
      position: relative;
      z-index: 1;
      flex: 1;
    }
    .step .circle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #ddd;
      color: #555;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .step.completed .circle {
      background: #28a745;
      color: white;
    }
    .step .label {
      font-size: 13px;
      display: block;
      margin-top: 2px;
    }
    .step.completed .label {
      color: #28a745;
      font-weight: 600;
    }
  </style>
</head>
<body class="p-4">

  <div class="container">
    <h2 class="mb-4">My Orders</h2>

    {% if orders %}
      <div class="accordion" id="ordersAccordion">
        {% for order in orders %}
          <!-- Accordion Item -->
          <div class="accordion-item mb-3 shadow-sm rounded">
            <h2 class="accordion-header" id="heading{{ order.id }}">
              <button class="accordion-button collapsed d-flex justify-content-between align-items-center" type="button" 
                      data-bs-toggle="collapse" data-bs-target="#collapse{{ order.id }}" 
                      aria-expanded="false" aria-controls="collapse{{ order.id }}">
                <div>
                  <span class="fw-bold">Order #{{ order.id }}</span> – ₹{{ order.total }}
                  <span class="ms-3 text-muted small">
                    Placed on {{ order.created_at.strftime('%d-%m-%Y %H:%M') if order.created_at }}
                  </span>
                </div>

                <span class="badge 
                  {% if order.status == 'Pending' %} bg-warning text-dark 
                  {% elif order.status == 'Shipped' %} bg-info text-dark
                  {% elif order.status == 'Delivered' %} bg-success
                  {% elif order.status == 'Cancelled' %} bg-danger
                  {% else %} bg-secondary
                  {% endif %}" 
                  style="cursor:pointer"
                  data-bs-toggle="modal" 
                  data-bs-target="#trackingModal{{ order.id }}">
                  {{ order.status }}
                </span>
              </button>
            </h2>

            <div id="collapse{{ order.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ order.id }}"
                 data-bs-parent="#ordersAccordion">
              <div class="accordion-body">
                <table class="table table-sm table-bordered mt-3">
                  <thead class="table-light">
                    <tr>
                      <th>Product</th>
                      <th>Price</th>
                      <th>Qty</th>
                      <th>Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in order.order_items %}
                      <tr>
                        <td>{{ item.product_name }}</td>
                        <td>₹{{ item.price }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>₹{{ item.subtotal }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Modals -->
      {% for order in orders %}
        <div class="modal fade" id="trackingModal{{ order.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Tracking Info - Order #{{ order.id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p><strong>Status:</strong> {{ order.status }}</p>

                <!-- Step Tracker -->
                <div class="order-tracker">
                  <div class="step {% if order.status in ['Pending','Shipped','Out for Delivery','Delivered'] %}completed{% endif %}">
                    <span class="circle">1</span>
                    <span class="label">Pending</span>
                  </div>
                  <div class="step {% if order.status in ['Shipped','Out for Delivery','Delivered'] %}completed{% endif %}">
                    <span class="circle">2</span>
                    <span class="label">Shipped</span>
                  </div>
                  <div class="step {% if order.status in ['Out for Delivery','Delivered'] %}completed{% endif %}">
                    <span class="circle">3</span>
                    <span class="label">Out for Delivery</span>
                  </div>
                  <div class="step {% if order.status == 'Delivered' %}completed{% endif %}">
                    <span class="circle">4</span>
                    <span class="label">Delivered</span>
                  </div>
                </div>

                {% if order.status == 'Cancelled' %}
                  <div class="alert alert-danger mt-3">This order has been Cancelled ❌</div>
                {% endif %}

                {% if order.tracking_number %}
                  <hr>
                  <p><strong>Tracking Number:</strong> {{ order.tracking_number }}</p>
                  <p><strong>Shipping Provider:</strong> {{ order.shipping_provider or "Not Available" }}</p>
                  <a href="https://www.google.com/search?q=track+{{ order.shipping_provider }}+{{ order.tracking_number }}" 
                     target="_blank" class="btn btn-outline-primary btn-sm">
                    Track Package
                  </a>
                {% else %}
                  <p class="text-muted mt-3">Tracking details not available yet.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}

    {% else %}
      <p>You have not placed any orders yet. <a href="{{ url_for('index') }}">Shop now</a></p>
    {% endif %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
